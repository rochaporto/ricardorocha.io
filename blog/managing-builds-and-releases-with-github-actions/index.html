<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ricardo Rocha"><meta name=description content="Software Engineer at CERN"><meta name=generator content="Hugo 0.60.0"><title>Managing Builds and Releases with GitHub Actions</title><link rel="shortcut icon" href=https://ricardorocha.io/images/favicon.ico><link rel=stylesheet href=https://ricardorocha.io/css/style.css><link rel=stylesheet href=https://ricardorocha.io/css/highlight.css><link rel=stylesheet href=https://ricardorocha.io/css/monosocialiconsfont.css><link href=https://ricardorocha.io/index.xml rel=alternate type=application/rss+xml title="Ricardo Rocha"><meta property="og:title" content="Managing Builds and Releases with GitHub Actions"><meta property="og:description" content="I've been a longtime user of Travis CI, specifically for a pet project managing gliding flights parsing and analysis - that in the past had iterations in Java and Python and has for several years been written in Go.
With recent talk about GitHub Actions and also seeing that a couple of new projects in the containers area seem to be using it, i decided to give this a go. The first results are pretty good and in this post i'll describe what's available and how to use this functionality to:"><meta property="og:type" content="article"><meta property="og:url" content="https://ricardorocha.io/blog/managing-builds-and-releases-with-github-actions/"><meta property="article:published_time" content="2019-12-02T18:00:00+00:00"><meta property="article:modified_time" content="2019-12-02T18:00:00+00:00"><meta itemprop=name content="Managing Builds and Releases with GitHub Actions"><meta itemprop=description content="I've been a longtime user of Travis CI, specifically for a pet project managing gliding flights parsing and analysis - that in the past had iterations in Java and Python and has for several years been written in Go.
With recent talk about GitHub Actions and also seeing that a couple of new projects in the containers area seem to be using it, i decided to give this a go. The first results are pretty good and in this post i'll describe what's available and how to use this functionality to:"><meta itemprop=datePublished content="2019-12-02T18:00:00&#43;00:00"><meta itemprop=dateModified content="2019-12-02T18:00:00&#43;00:00"><meta itemprop=wordCount content="667"><meta itemprop=keywords content="dev,git,github,github actions,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Managing Builds and Releases with GitHub Actions"><meta name=twitter:description content="I've been a longtime user of Travis CI, specifically for a pet project managing gliding flights parsing and analysis - that in the past had iterations in Java and Python and has for several years been written in Go.
With recent talk about GitHub Actions and also seeing that a couple of new projects in the containers area seem to be using it, i decided to give this a go. The first results are pretty good and in this post i'll describe what's available and how to use this functionality to:"><meta name=twitter:site content="@https://twitter.com/ahcorporto"></head><body><nav class=main-nav><a href=https://ricardorocha.io/><span class=arrow>‚Üê</span>Home</a>
<a href=/blog/>Blog</a>
<a href=/project>Projects</a>
<a href=/talk/>Talks</a>
<a href=/story/>Stories</a>
<a href=/about/>About</a>
<a href=https://ricardorocha.io/index.xml>RSS</a></nav><section id=wrapper><article class=post><header><h1>Managing Builds and Releases with GitHub Actions</h1><h2 class=headline>December 2, 2019 - 4 min read<br><a href=https://ricardorocha.io/tags/dev>dev</a>
<a href=https://ricardorocha.io/tags/git>git</a>
<a href=https://ricardorocha.io/tags/github>github</a>
<a href=https://ricardorocha.io/tags/github-actions>github actions</a></h2></header><section id=post-body><p>I've been a longtime user of Travis CI, specifically for a <a href=https://github.com/ezgliding/goigc>pet project</a>
managing gliding flights parsing and analysis - that in the past had iterations in
Java and Python and has for several years been written in Go.</p><p>With recent talk about GitHub Actions and also seeing that a couple of
new projects in the containers area seem to be using it, i decided to give this
a go. The first results are pretty good and in this post i'll describe what's
available and how to use this functionality to:</p><ul><li>Build cross platform Go binaries, plus test and coverage</li><li>Build and publish Docker containers into registries</li><li>Automate GitHub release creation using tags, including generation of changelogs</li></ul><h2 id=workflow>Workflow</h2><p>GitHub Actions allow the creation of workflows with each step automating some
custom process. These can be building and packaging software, deploying to some
external service, generating code quality reports, among many others.
They are stored under <code>.github/workflows</code> and defined in yaml, and you can
have as many as you want.</p><p>Workflows are based on events such as pushing new code, new branches or tags to a
repository, opening or closing pull requests, commenting on a PR, etc. In my
example i want to trigger for all branch updates, tags starting with <code>v</code> - my
version tag convention - and i want to skip the workflow for doc file changes.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>on:
  push:
    branches:
      - <span style=color:#e6db74>&#39;*&#39;</span>
    tags:
      - <span style=color:#e6db74>&#39;v*&#39;</span>
    paths-ignore:
      - <span style=color:#e6db74>&#39;CONTRIBUTING.md&#39;</span>
      - <span style=color:#e6db74>&#39;README.md&#39;</span>
      - <span style=color:#e6db74>&#39;docs/**&#39;</span></code></pre></div></p><p>One of the best features of GitHub Actions is the <a href="https://github.com/marketplace?type=actions">Marketplace</a>,
where you can find reusable components for most common tasks. An example is
the <a href=https://github.com/marketplace/actions/gh-release>GH Release</a> action to
automate the creation of GitHub releases everytime a new tag is pushed.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - name: Release cross platform binaries
    uses: softprops/action-gh-release@v1
    if: startsWith(github.ref, <span style=color:#e6db74>&#39;refs/tags/v&#39;</span>)
    with:
      files: <span style=color:#e6db74>|
</span><span style=color:#e6db74>       </span><span style=color:#e6db74> </span><span style=color:#e6db74>_dist/**</span>
      body_path: CHANGELOG.md
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
</code></pre></div><p>This step relies on <a href=https://github.com/marketplace/actions/gh-release>softprops/action-gh-release@v1</a>
and i pass it the list of assets that go with it (the previously
built binaries for each platform) as well as the generated changelog. I found
this simpler than relying on the official <a href=https://github.com/marketplace/actions/create-a-release>create-release</a>
action which requires a <a href=https://github.com/actions/upload-release-asset>separate step</a>
to upload assets.</p><p>Notice that this step has a condition so that it is only triggered for version
tags, and ignored for other tags as well as branch updates.</p><p>The build step it depends on relies on the wonderful <a href=https://github.com/mitchellh/gox>gox</a>
tool which does cross compilation for multiple platforms. Another option would
be to rely on Github Actions's <a href=https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#jobsjob_idstrategy>matrix strategy</a> to truly run the builds on multiple platforms, but this is rarely needed when
building Go binaries.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - name: Make build for cross platform binaries
    run: <span style=color:#e6db74>|
</span><span style=color:#e6db74>     </span><span style=color:#e6db74> </span><span style=color:#e6db74>make build-cross</span>
</code></pre></div><h2 id=makefile-actions>Makefile Actions</h2><p>In the last step above we simply call a make target. The decision to keep most
of the build steps in a Makefile while there are equivalent GitHub Actions is
to still be able to replicate these steps offline. Wrapping them as individual
steps in the workflow is trivial.</p><p>Check the full Makefile <a href=https://github.com/ezgliding/goigc/blob/master/Makefile>here</a>,
heavily based on <a href=https://github.com/helm/helm/blob/master/Makefile>this one</a>
from the Helm project. Targets include <code>build</code>, <code>build-cross</code>, <code>test</code>, <code>test-coverage</code>,
<code>changelog</code>, <code>docker</code> and <code>docker-push</code>. Here's the <code>build-cross</code> target from
above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>.PHONY: build-cross
build-cross: LDFLAGS <span style=color:#f92672>+=</span> -extldflags <span style=color:#e6db74>&#34;-static&#34;</span>
build-cross: <span style=color:#66d9ef>$(</span>GOX<span style=color:#66d9ef>)</span>
	GO111MODULE<span style=color:#f92672>=</span>on CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>$(</span>GOX<span style=color:#66d9ef>)</span> -parallel<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      -output<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>_dist/{{.OS}}-{{.Arch}}/</span><span style=color:#66d9ef>$(</span>BINNAME<span style=color:#66d9ef>)</span><span style=color:#e6db74>_{{.OS}}_{{.Arch}}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      -osarch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;$(TARGETS)&#39;</span> <span style=color:#66d9ef>$(</span>GOFLAGS<span style=color:#66d9ef>)</span> -tags <span style=color:#e6db74>&#39;$(TAGS)&#39;</span> -ldflags <span style=color:#e6db74>&#39;$(LDFLAGS)&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      ./cmd/goigc
</code></pre></div><h2 id=generating-changelog>Generating Changelog</h2><p>The goal is to generate the changelog before creating the release, and include
the result in the body text. I spent some time choosing an option for this,
there are again <a href="https://github.com/marketplace?utf8=%E2%9C%93&amp;type=actions&amp;query=changelog">multiple GitHub Actions</a>
for this task.</p><p>In the end i still relied on the <a href=https://github.com/github-changelog-generator/github-changelog-generator>github_changelog_generator</a>
with some built-in logic to track the previous tag, here's the Makefile target.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>changelog:
	@./scripts/changelog.sh
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat scripts/changelog
...
github_changelog_generator -u ezgliding -p goigc --since-tag <span style=color:#66d9ef>$(</span>git describe --abbrev<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> --tags <span style=color:#e6db74>`</span>git rev-list --tags --skip<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> --max-count<span style=color:#f92672>=</span>1<span style=color:#e6db74>`</span><span style=color:#66d9ef>)</span>
</code></pre></div><h2 id=visualization>Visualization</h2><p>The great integration with the rest of GitHub is also very useful.</p><figure><img src=/images/blog/github-actions-goigc.png width=100%></figure><p>You can easily <a href=https://github.com/ezgliding/goigc/actions>browse the workflows</a>,
check logs and retrieve any artifacts from the different steps.</p><p>It's been a positive transition and i don't think i'll move back.</p></section></article><footer id=footer><div id=social><a class=symbol href=https://github.com/rochaporto>roundedgithub</a>
<a class=symbol href=https://www.linkedin.com/in/ricardo-rocha-739aa718>roundedlinkedin</a>
<a class=symbol href=https://twitter.com/ahcorporto>roundedtwitterbird</a></div><p class=small>@ Copyright 2020 Ricardo Rocha, Built with Hugo</p></footer></section><script src=//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js></script><script src=https://ricardorocha.io/js/main.js></script><script src=https://ricardorocha.io/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>